<svg xmlns="http://www.w3.org/2000/svg" width="1800" height="1120" viewBox="0 0 1800 1120" role="img" aria-labelledby="title desc">
  <title id="title">Pick-Pro Current Architecture</title>
  <desc id="desc">Current production architecture using React, RTDB, anonymous auth, workers, event sourcing, and PWA service worker.</desc>

  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#0b1220"/>
      <stop offset="100%" stop-color="#0f172a"/>
    </linearGradient>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#93c5fd"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#86efac"/>
    </marker>
    <marker id="arrowAmber" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#fcd34d"/>
    </marker>
    <style>
      .title { font: 700 30px Inter, Segoe UI, Roboto, Arial, sans-serif; fill: #f8fafc; }
      .subtitle { font: 500 14px Inter, Segoe UI, Roboto, Arial, sans-serif; fill: #cbd5e1; }
      .section { font: 700 18px Inter, Segoe UI, Roboto, Arial, sans-serif; fill: #e2e8f0; }
      .box-title { font: 700 15px Inter, Segoe UI, Roboto, Arial, sans-serif; fill: #f8fafc; }
      .box-text { font: 500 13px Inter, Segoe UI, Roboto, Arial, sans-serif; fill: #cbd5e1; }
      .small { font: 500 12px Inter, Segoe UI, Roboto, Arial, sans-serif; fill: #cbd5e1; }
      .line-blue { stroke: #93c5fd; stroke-width: 2.2; fill: none; marker-end: url(#arrow); }
      .line-green { stroke: #86efac; stroke-width: 2.2; fill: none; marker-end: url(#arrowGreen); }
      .line-amber { stroke: #fcd34d; stroke-width: 2.2; fill: none; marker-end: url(#arrowAmber); }
      .line-dash { stroke-dasharray: 7 6; }
    </style>
  </defs>

  <rect x="0" y="0" width="1800" height="1120" fill="url(#bg)"/>

  <text x="40" y="52" class="title">Pick-Pro Current App Architecture (RTDB + Event Sourcing)</text>
  <text x="40" y="80" class="subtitle">As implemented: anonymous auth, path-scoped subscriptions, local queue, workers, leaderboard aggregation</text>

  <!-- Browser shell -->
  <rect x="30" y="110" width="1100" height="960" rx="20" fill="#111827" stroke="#334155" stroke-width="1.5"/>
  <text x="55" y="145" class="section">Client (Web / React + Vite PWA)</text>

  <!-- UI layer -->
  <rect x="60" y="170" width="470" height="180" rx="14" fill="#1e293b" stroke="#475569"/>
  <text x="80" y="198" class="box-title">UI Modules</text>
  <text x="80" y="222" class="box-text">`App.jsx`, `TournamentHub`, `TournamentView`,</text>
  <text x="80" y="242" class="box-text">`MatchList`, `StandingsTable`, setup/admin flows</text>
  <text x="80" y="270" class="small">Renders live standings, history, rankings, match controls</text>
  <text x="80" y="292" class="small">Non-blocking UX (no full-screen loading gate)</text>

  <!-- State/hooks -->
  <rect x="560" y="170" width="540" height="260" rx="14" fill="#1e293b" stroke="#475569"/>
  <text x="580" y="198" class="box-title">Data + Domain Hooks</text>
  <text x="580" y="222" class="box-text">`useTournaments`</text>
  <text x="600" y="242" class="small">- subscribes `tournaments_meta`, `leaderboard_global`, `roster`</text>
  <text x="600" y="262" class="small">- one-time leaderboard bootstrap (schema/version guard)</text>
  <text x="600" y="282" class="small">- backfills `playersPreview` + `playerCount` in meta</text>

  <text x="580" y="312" class="box-text">`useActiveTournament`</text>
  <text x="600" y="332" class="small">- path listeners on active `tournament_data/{id}` subtrees</text>
  <text x="600" y="352" class="small">- merges via `applyEventSourcing` (+ `scoreSnapshot` baseline)</text>

  <text x="580" y="382" class="box-text">`useScoring`</text>
  <text x="600" y="402" class="small">- optimistic local score updates + haptics</text>

  <!-- Event pipeline -->
  <rect x="60" y="380" width="1040" height="250" rx="14" fill="#1f2937" stroke="#475569"/>
  <text x="80" y="408" class="box-title">Scoring Event Pipeline</text>

  <rect x="80" y="430" width="300" height="170" rx="10" fill="#0f172a" stroke="#334155"/>
  <text x="95" y="456" class="box-text">1) Score tap (admin)</text>
  <text x="95" y="478" class="small">`adjustScore(mIdx, team, delta)`</text>
  <text x="95" y="500" class="small">adds `clientEventId`, `sourceId`,</text>
  <text x="95" y="520" class="small">`nextScore`, `ts`, `isKnockout`</text>

  <rect x="410" y="430" width="320" height="170" rx="10" fill="#0f172a" stroke="#334155"/>
  <text x="425" y="456" class="box-text">2) Offline queue + retry</text>
  <text x="425" y="478" class="small">LocalForage store: `pending-score-events-v1`</text>
  <text x="425" y="500" class="small">flush on startup + `online` event</text>
  <text x="425" y="522" class="small">dedupe by `clientEventId`</text>

  <rect x="760" y="430" width="320" height="170" rx="10" fill="#0f172a" stroke="#334155"/>
  <text x="775" y="456" class="box-text">3) RTDB append + replay</text>
  <text x="775" y="478" class="small">push to `tournament_data/{id}/events`</text>
  <text x="775" y="500" class="small">reducer applies sorted events</text>
  <text x="775" y="522" class="small">cross-admin dedupe window + absolute `nextScore`</text>
  <text x="775" y="544" class="small">periodic compaction -> `scoreSnapshot` + clear events</text>

  <!-- Workers -->
  <rect x="60" y="660" width="1040" height="180" rx="14" fill="#1f2937" stroke="#475569"/>
  <text x="80" y="688" class="box-title">Background Compute (Web Workers)</text>

  <rect x="80" y="710" width="470" height="110" rx="10" fill="#0f172a" stroke="#334155"/>
  <text x="95" y="736" class="box-text">`tournamentBuilder.worker.js`</text>
  <text x="95" y="758" class="small">auto-generate tournament layouts (pairs/mixer/singles)</text>
  <text x="95" y="780" class="small">keeps setup UI responsive for larger drafts</text>

  <rect x="580" y="710" width="500" height="110" rx="10" fill="#0f172a" stroke="#334155"/>
  <text x="595" y="736" class="box-text">`standings.worker.js` + `standingsCalculator`</text>
  <text x="595" y="758" class="small">off-main-thread standings + tie-break calculation</text>
  <text x="595" y="780" class="small">fallback to main-thread calculator on worker error</text>

  <!-- PWA -->
  <rect x="60" y="870" width="1040" height="170" rx="14" fill="#1f2937" stroke="#475569"/>
  <text x="80" y="898" class="box-title">PWA Layer</text>
  <text x="80" y="922" class="box-text">`vite-plugin-pwa` + Workbox generated service worker</text>
  <text x="80" y="944" class="small">`registerSW({ immediate: true })` in `main.jsx`</text>
  <text x="80" y="966" class="small">asset/runtime cache for app shell and fonts; supports resilient reloads</text>

  <!-- Firebase cloud -->
  <rect x="1160" y="110" width="610" height="960" rx="20" fill="#0f1a2b" stroke="#334155" stroke-width="1.5"/>
  <text x="1185" y="145" class="section">Firebase Backend</text>

  <!-- Auth -->
  <rect x="1190" y="175" width="550" height="110" rx="12" fill="#132033" stroke="#334155"/>
  <text x="1210" y="202" class="box-title">Firebase Auth</text>
  <text x="1210" y="224" class="box-text">Anonymous sign-in (`ensureFirebaseSession`)</text>
  <text x="1210" y="246" class="small">Required for RTDB writes under `auth != null` rules</text>

  <!-- RTDB -->
  <rect x="1190" y="310" width="550" height="620" rx="12" fill="#132033" stroke="#334155"/>
  <text x="1210" y="338" class="box-title">Realtime Database (RTDB)</text>

  <rect x="1210" y="358" width="510" height="100" rx="10" fill="#0b1628" stroke="#334155"/>
  <text x="1225" y="384" class="box-text">`tournaments_meta/{id}`</text>
  <text x="1225" y="406" class="small">name, status, format, winner, `playersPreview`, `playerCount`</text>
  <text x="1225" y="428" class="small">hub cards read from this lightweight node</text>

  <rect x="1210" y="474" width="510" height="150" rx="10" fill="#0b1628" stroke="#334155"/>
  <text x="1225" y="500" class="box-text">`tournament_data/{id}`</text>
  <text x="1225" y="522" class="small">matches, knockouts, draftPlayers/teams/players, format/status</text>
  <text x="1225" y="544" class="small">`events/*` (SCORE stream), `scoreSnapshot` (compaction baseline)</text>
  <text x="1225" y="566" class="small">active tournament subscribes path-by-path, not full global tree</text>

  <rect x="1210" y="640" width="510" height="130" rx="10" fill="#0b1628" stroke="#334155"/>
  <text x="1225" y="666" class="box-text">`leaderboard_global/{playerKey}`</text>
  <text x="1225" y="688" class="small">W/L/PD/PF/PA aggregate across all completed matches</text>
  <text x="1225" y="710" class="small">updated idempotently on confirm-match / confirm-knockout</text>
  <text x="1225" y="732" class="small">guard path: `leaderboard_applied/{tournamentId}/{scope}/{idx}`</text>

  <rect x="1210" y="786" width="510" height="120" rx="10" fill="#0b1628" stroke="#334155"/>
  <text x="1225" y="812" class="box-text">`leaderboard_meta` + `roster`</text>
  <text x="1225" y="834" class="small">schemaVersion/rebuiltAt for bootstrap gating</text>
  <text x="1225" y="856" class="small">roster is shared player directory</text>

  <!-- Rules -->
  <rect x="1190" y="945" width="550" height="95" rx="12" fill="#132033" stroke="#334155"/>
  <text x="1210" y="972" class="box-title">Rules / Security</text>
  <text x="1210" y="994" class="box-text">`firebase/database.rules.json`</text>
  <text x="1210" y="1016" class="small">root deny by default, indexed hot paths, write validation on events</text>

  <!-- Cross-system arrows -->
  <path d="M530 260 C 620 260, 620 250, 560 250" class="line-dash line-blue"/>
  <path d="M380 515 L 410 515" class="line-green"/>
  <path d="M730 515 L 760 515" class="line-green"/>

  <path d="M1100 250 L 1190 230" class="line-blue"/>
  <text x="1095" y="228" class="small">session token</text>

  <path d="M1100 515 L 1210 550" class="line-green"/>
  <text x="1110" y="500" class="small">score events</text>

  <path d="M1210 600 L 1100 585" class="line-blue"/>
  <text x="1080" y="610" class="small">active tour data</text>

  <path d="M1210 420 L 1100 310" class="line-blue"/>
  <text x="1065" y="350" class="small">meta list/cards</text>

  <path d="M1210 705 L 1100 720" class="line-amber"/>
  <text x="1070" y="742" class="small">global leaderboard feed</text>

  <path d="M980 810 C 1120 860, 1120 900, 1210 900" class="line-dash line-amber"/>
  <text x="985" y="842" class="small">bootstrap/rebuild (when needed)</text>

  <!-- Legend -->
  <rect x="40" y="1040" width="1720" height="50" rx="10" fill="#111827" stroke="#334155"/>
  <line x1="70" y1="1066" x2="120" y2="1066" class="line-blue"/>
  <text x="130" y="1071" class="small">Read / subscribe flows</text>
  <line x1="350" y1="1066" x2="400" y2="1066" class="line-green"/>
  <text x="410" y="1071" class="small">Write / mutate flows</text>
  <line x1="620" y1="1066" x2="670" y2="1066" class="line-amber"/>
  <text x="680" y="1071" class="small">Derived/aggregate flows</text>
  <line x1="930" y1="1066" x2="980" y2="1066" class="line-dash line-blue"/>
  <text x="990" y="1071" class="small">Asynchronous/background processes</text>
</svg>
